---
- assert:
    that:
      - wildfly_user is defined
      - wildfly_group is defined
      - wildfly_uid is defined
      - wildfly_gid is defined
    quiet: true

- name: "Create {{ wildfly_group }} group"
  group:
    name: "{{ wildfly_group }}"
    state: present
    gid: "{{ wildfly_gid }}"

- name: "Create {{ wildfly_user }} user"
  user:
    name: "{{ wildfly_user }}"
    comment: JBoss User
    uid: "{{ wildfly_uid }}"
    group: "{{ wildfly_group }}"
    home: "{{ jboss_home_directory }}"
    state: present

# Add the WildFly distribution to /opt, and make wildfly the owner of the extracted tar content
- name: Download and Add WildFly distribution
  block:
    - name: Download tar ball
      get_url:
        url: "https://download.jboss.org/wildfly/{{ wildfly_version }}/wildfly-{{ wildfly_version }}.tar.gz"
        dest: "{{ jboss_home_directory }}/wildfly-{{ wildfly_version }}.tar.gz"

    - name: Add WildFly distribution
      shell: >
        sha1sum wildfly-$WILDFLY_VERSION.tar.gz | grep $WILDFLY_SHA1 \
        && tar xf wildfly-$WILDFLY_VERSION.tar.gz \
        && mv wildfly-$WILDFLY_VERSION $JBOSS_HOME \
        && rm -rf wildfly-$WILDFLY_VERSION.tar.gz \
        && chown -R jboss:0 ${JBOSS_HOME} \
        && chmod -R g+rw ${JBOSS_HOME}
      args:
        chdir: "{{ jboss_home_directory }}"
